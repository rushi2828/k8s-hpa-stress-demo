# 🚀 k8s-hpa-stress-demo [CPU HPA Demo on Kubernetes]
This project demonstrates how to use the Kubernetes **Horizontal Pod Autoscaler (HPA)** to scale a CPU-intensive container (`vish/stress`) based on **CPU utilization**. It's built and tested to work with [KIND](https://kind.sigs.k8s.io/) and supports GitOps best practices.

---

## 📁 Project Structure

```
k8s-hpa-stress-demo/
├── .github/
│   └── workflows/
│       └── validate-manifests.yaml   # GitHub Actions CI
├── k8s/
│   ├── deployment.yaml               # CPU burner deployment
│   ├── hpa.yaml                      # Horizontal Pod Autoscaler config
│   ├── kustomization.yaml            # Kustomize support
│   └── namespace.yaml                # Project namespace
├── manifests/                        # Generated by kustomize
├── .gitignore
└── README.md
```

---

## 🔧 Prerequisites

- [kubectl](https://kubernetes.io/docs/tasks/tools/)
- [kind](https://kind.sigs.k8s.io/)
- Metrics Server installed in your KIND cluster  
  👉 [Install Instructions](#installing-metrics-server-on-kind)

---

## 🚀 Deploy the HPA Demo

```
kubectl apply -f k8s/namespace.yaml
kubectl apply -f k8s/
```

---

## 🔥 Simulating CPU Load

The container uses the \`vish/stress\` image to burn CPU using:

```
-cpus 1
```

This creates enough load to trigger scaling based on the HPA thresholds.

---

## 📈 Monitoring HPA

```
kubectl get hpa -n hpa-demo --watch
kubectl get pods -n hpa-demo -w
kubectl describe hpa cpu-burner-hpa -n hpa-demo
```

Once load increases, the number of pods should scale from 1 up to 5.

---

## 🧼 Cleanup

```
kubectl delete ns hpa-demo
```

---

## 📊 Installing Metrics Server on KIND

The Metrics Server is not installed by default in KIND. Run:

```
kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml

kubectl patch deployment metrics-server -n kube-system \
  --type=json \
  -p='[{"op": "add", "path": "/spec/template/spec/containers/0/args/-", "value": "--kubelet-insecure-tls"}]'
```

Then verify:

```
kubectl top nodes
kubectl top pods -n hpa-demo
```

---

## ⚙️ CI/CD with GitHub Actions

A GitHub Actions workflow is included that:

- Validates all Kubernetes YAML manifests
- Runs \`kustomize build\`
- Uses [\`kubeconform\`](https://github.com/yannh/kubeconform) for strict schema validation
- Performs \`kubectl apply --dry-run=client\`

```
.github/workflows/validate-manifests.yaml
```

---

## ✅ Tech Stack

- 🐳 \`vish/stress\` — simple CPU burner container
- ⚙️ Kubernetes HPA (v2)
- 💥 KIND (Kubernetes in Docker)
- 📦 GitHub Actions
- 📐 Kustomize (optional)
- 🔍 kubeconform (validation)

---
